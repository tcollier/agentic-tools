#!/usr/bin/env bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# GitHub repository
GITHUB_REPO="https://github.com/tcollier/agentic-tools.git"

# Script directory (where this script is located)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
AGENTS_SOURCE="$REPO_ROOT/claude/agents"
COMMANDS_SOURCE="$REPO_ROOT/claude/commands"
CRITERIA_SOURCE="$REPO_ROOT/claude/production-criteria.md"
# PREFS_EXAMPLE_SOURCE removed - no longer needed

# Check if we're running from a cloned repo or need to download
if [[ ! -d "$COMMANDS_SOURCE" ]]; then
  echo -e "${BLUE}Installing from remote repository...${NC}"

  # Create temporary directory
  TEMP_DIR=$(mktemp -d)
  trap "rm -rf $TEMP_DIR" EXIT

  # Clone the repository
  echo -e "${BLUE}Downloading agentic-tools...${NC}"
  if ! git clone --quiet --depth 1 "$GITHUB_REPO" "$TEMP_DIR/agentic-tools" 2>/dev/null; then
    echo -e "${RED}Error: Failed to download repository${NC}"
    echo "Please ensure git is installed and you have internet connectivity"
    exit 1
  fi

  # Re-execute the install script from the cloned repo
  exec bash "$TEMP_DIR/agentic-tools/claude/bin/install" "$@"
fi

# Installation mode (will be set by args or interactive prompt)
INSTALL_MODE=""
PROJECT_PATH=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --global)
      INSTALL_MODE="global"
      shift
      ;;
    --project)
      if [[ -z "$2" ]]; then
        echo -e "${RED}Error: --project requires a path argument${NC}"
        exit 1
      fi
      INSTALL_MODE="project"
      PROJECT_PATH="$2"
      shift 2
      ;;
    --help|-h)
      echo "Usage: $0 [OPTIONS]"
      echo ""
      echo "Install Claude Code custom commands and configuration"
      echo ""
      echo "Options:"
      echo "  --global            Install globally to ~/.claude/ (available in all projects)"
      echo "  --project <path>    Install to project directory (only available in that project)"
      echo "  --help, -h          Show this help message"
      echo ""
      echo "Examples (from cloned repo):"
      echo "  $0                           # Interactive mode - asks where to install"
      echo "  $0 --global                  # Install globally to ~/.claude/"
      echo "  $0 --project .               # Install to current project (./.claude/)"
      echo "  $0 --project /path/to/proj   # Install to /path/to/proj/.claude/"
      echo ""
      echo "Remote installation (one-liner):"
      echo "  curl -fsSL https://raw.githubusercontent.com/tcollier/agentic-tools/main/claude/bin/install | bash"
      echo "  curl -fsSL https://raw.githubusercontent.com/tcollier/agentic-tools/main/claude/bin/install | bash -s -- --global"
      echo ""
      echo "Available commands:"
      echo "  /repo-readiness - Evaluate repo readiness for current company stage"
      exit 0
      ;;
    *)
      echo -e "${RED}Error: Unknown option $1${NC}"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

# If no installation mode specified, ask the user
if [[ -z "$INSTALL_MODE" ]]; then
  echo -e "${BLUE}Where would you like to install the Claude Code commands?${NC}"
  echo ""
  echo "1) Global installation (${HOME}/.claude/)"
  echo "   → Commands available in all projects"
  echo "   → Good for personal development machine"
  echo ""
  echo "2) Project installation ($(pwd)/.claude/)"
  echo "   → Commands only available in this project"
  echo "   → Good for sharing with team via git"
  echo ""
  read -p "Choose [1/2]: " choice </dev/tty

  case $choice in
    1)
      INSTALL_MODE="global"
      echo -e "${GREEN}Installing globally to ~/.claude/${NC}"
      ;;
    2)
      INSTALL_MODE="project"
      PROJECT_PATH="$(pwd)"
      echo -e "${GREEN}Installing to project at $(pwd)/.claude/${NC}"
      ;;
    *)
      echo -e "${RED}Invalid choice. Exiting.${NC}"
      exit 1
      ;;
  esac
  echo ""
fi

# Set target directories based on mode
if [[ "$INSTALL_MODE" == "global" ]]; then
  AGENTS_TARGET_DIR="$HOME/.claude/agents"
  COMMANDS_TARGET_DIR="$HOME/.claude/commands"
  IS_PROJECT_INSTALL=false
else
  AGENTS_TARGET_DIR="$PROJECT_PATH/.claude/agents"
  COMMANDS_TARGET_DIR="$PROJECT_PATH/.claude/commands"
  IS_PROJECT_INSTALL=true
fi

# Validate source directories exist
if [[ ! -d "$COMMANDS_SOURCE" ]] && [[ ! -d "$AGENTS_SOURCE" ]]; then
  echo -e "${RED}Error: Source directories not found${NC}"
  echo "Make sure you're running this script from the repository root"
  exit 1
fi

# Create target directories
echo -e "${BLUE}Creating target directories...${NC}"
[[ -d "$AGENTS_SOURCE" ]] && mkdir -p "$AGENTS_TARGET_DIR"
mkdir -p "$COMMANDS_TARGET_DIR"

# Install agents (if they exist)
if [[ -d "$AGENTS_SOURCE" ]]; then
  AGENT_COUNT=$(find "$AGENTS_SOURCE" -maxdepth 1 -name "*.md" -not -name "README.md" 2>/dev/null | wc -l | tr -d ' ')

  if [[ "$AGENT_COUNT" -gt 0 ]]; then
    echo -e "${BLUE}Installing $AGENT_COUNT agent(s)...${NC}"
    for agent in "$AGENTS_SOURCE"/*.md; do
      # Skip README
      if [[ "$(basename "$agent")" == "README.md" ]]; then
        continue
      fi

      agent_name="$(basename "$agent")"
      target_file="$AGENTS_TARGET_DIR/$agent_name"

      if [[ -f "$target_file" ]]; then
        echo -e "  ${YELLOW}↻${NC} Updating $agent_name"
      else
        echo -e "  ${GREEN}✓${NC} Installing $agent_name"
      fi
      cp "$agent" "$AGENTS_TARGET_DIR/"
    done
  fi
fi

# Count and install commands
if [[ -d "$COMMANDS_SOURCE" ]]; then
  COMMAND_COUNT=$(find "$COMMANDS_SOURCE" -maxdepth 1 -name "*.md" -not -name "README.md" | wc -l | tr -d ' ')

  if [[ "$COMMAND_COUNT" -gt 0 ]]; then
    echo -e "${BLUE}Installing $COMMAND_COUNT command(s)...${NC}"
    for command in "$COMMANDS_SOURCE"/*.md; do
      # Skip README
      if [[ "$(basename "$command")" == "README.md" ]]; then
        continue
      fi

      command_name="$(basename "$command")"
      target_file="$COMMANDS_TARGET_DIR/$command_name"

      if [[ -f "$target_file" ]]; then
        echo -e "  ${YELLOW}↻${NC} Updating $command_name"
      else
        echo -e "  ${GREEN}✓${NC} Installing $command_name"
      fi
      cp "$command" "$COMMANDS_TARGET_DIR/"
    done
  fi
fi

# Install production criteria (always overwrite to get latest)
if [[ "$IS_PROJECT_INSTALL" == true ]]; then
  CRITERIA_TARGET="$(dirname "$AGENTS_TARGET_DIR")/production-criteria.md"
else
  CRITERIA_TARGET="$HOME/.claude/production-criteria.md"
fi

if [[ -f "$CRITERIA_SOURCE" ]]; then
  echo -e "${BLUE}Installing production criteria...${NC}"
  if [[ -f "$CRITERIA_TARGET" ]]; then
    echo -e "  ${YELLOW}↻${NC} Updating production-criteria.md"
  else
    echo -e "  ${GREEN}✓${NC} Installing production-criteria.md"
  fi
  cp "$CRITERIA_SOURCE" "$CRITERIA_TARGET"
fi

# Success message
echo ""
echo -e "${GREEN}Installation complete!${NC}"
echo ""

if [[ "$IS_PROJECT_INSTALL" == true ]]; then
  echo -e "Commands installed to: ${BLUE}$COMMANDS_TARGET_DIR${NC}"
  [[ -d "$AGENTS_TARGET_DIR" ]] && echo -e "Agents installed to: ${BLUE}$AGENTS_TARGET_DIR${NC}"
  echo -e "Configuration: ${BLUE}$(dirname "$COMMANDS_TARGET_DIR")${NC}"
  echo ""
  echo "To use in this project:"
  echo -e "  ${BLUE}/repo-readiness${NC}   - Evaluate repo readiness for current stage"
else
  echo -e "Commands installed globally to: ${BLUE}$COMMANDS_TARGET_DIR${NC}"
  [[ -d "$AGENTS_TARGET_DIR" ]] && echo -e "Agents installed globally to: ${BLUE}$AGENTS_TARGET_DIR${NC}"
  echo -e "Configuration: ${BLUE}$HOME/.claude${NC}"
  echo ""
  echo "To use in any project:"
  echo -e "  ${BLUE}/repo-readiness${NC}   - Evaluate repo readiness for current stage"
fi

if [[ -d "$AGENTS_SOURCE" ]] && [[ -n "$(find "$AGENTS_SOURCE" -maxdepth 1 -name "*.md" -not -name "README.md" 2>/dev/null)" ]]; then
  echo ""
  echo "Available agents:"
  for agent in "$AGENTS_SOURCE"/*.md; do
    if [[ "$(basename "$agent")" != "README.md" ]]; then
      agent_name="$(basename "$agent" .md)"
      echo -e "  • ${GREEN}$agent_name${NC}"
    fi
  done
fi

if [[ -d "$COMMANDS_SOURCE" ]] && [[ -n "$(find "$COMMANDS_SOURCE" -maxdepth 1 -name "*.md" -not -name "README.md" 2>/dev/null)" ]]; then
  echo ""
  echo "Available commands:"
  for command in "$COMMANDS_SOURCE"/*.md; do
    if [[ "$(basename "$command")" != "README.md" ]]; then
      command_name="$(basename "$command" .md)"
      echo -e "  • ${GREEN}/$command_name${NC}"
    fi
  done
fi
