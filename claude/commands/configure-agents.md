# Configure Agents Command

Add or update stage-specific development criteria in AGENTS.md to guide AI coding assistants in making stage-appropriate architectural and implementation decisions.

**Purpose:** Generate comprehensive, stage-specific development guidelines that help AI agents understand what matters (and what doesn't) at your company's current stage.

## Process

### 1. Load or Prompt for Company Stage

Check if `.claude/config.json` exists and contains stage configuration.

**If config exists:**
- Read `companyStage` value (1-6)
- Display current stage to user
- Ask if they want to change it:
  - If yes, proceed to stage selection
  - If no, use existing stage and skip to Step 2

**If config doesn't exist OR user wants to change:**
- Display the 6-stage table from `production-criteria.md` (or `.claude/production-criteria.md`)
- Use AskUserQuestion tool to prompt user to select stage (1-6)
- Show options for all 6 stages with descriptions

**Stage Options for AskUserQuestion:**

1. **Stage 1: Exploratory** - Building prototypes to learn ($0, 1-3 people)
2. **Stage 2: Early Validation** - First paying customers (<$10K MRR, 2-5 people)
3. **Stage 3: Proven Concept** - Repeatable sales process ($10K-$100K MRR, 5-15 people)
4. **Stage 4: Early Scaling** - Scaling infrastructure ($100K-$1M MRR, 15-50 people)
5. **Stage 5: Hypergrowth** - Racing to keep up with demand ($1M+ MRR, 50-500+ people)
6. **Stage 6: Established** - Sustainable growth, focus on efficiency

**Save configuration:**
Create or update `.claude/config.json` with:
```json
{
  "companyStage": <selected_stage_number>,
  "stageName": "<stage_name>",
  "lastUpdated": "<ISO_timestamp>",
  "_comment": "Stage configuration for this repository. Valid stages: 1 (Exploratory), 2 (Early Validation), 3 (Proven Concept), 4 (Early Scaling), 5 (Hypergrowth), 6 (Established)"
}
```

### 2. Read Production Criteria

Read the production criteria file to extract stage-specific content:
- Try `claude/production-criteria.md` first
- If not found, try `.claude/production-criteria.md`
- Extract all relevant sections for the configured stage

**Content to extract:**
- Stage characteristics (revenue, team size, key signal)
- What matters at this stage (from "What Matters at Each Stage" table)
- Priority levels (P0, P1, P2) definitions
- Essential Criteria (all 10 categories)
- AI Agent Readiness section with stage-appropriate priority
- Technical Design Quality for this stage

### 3. Generate Comprehensive Stage-Specific Criteria Section

Create a markdown section with the following structure. Use the exact format shown below, substituting stage-specific content from `production-criteria.md`:

```markdown
<!-- BEGIN: Stage-Specific Criteria (Auto-generated by /configure-agents) -->
## Stage-Specific Development Criteria

**Company Stage:** {stage_number}. {stage_name}
**Last Updated:** {ISO_timestamp}

*This section is automatically generated based on your company stage configuration. To update after a stage change, run `/configure-agents` again.*

---

### Stage {N} Overview

**Revenue:** {revenue_range}
**Team Size:** {team_size_range}
**Key Signal:** {key_signal}

{1-2 paragraph explanation of what this stage means for the company}

---

### Development Priorities at Stage {N}

#### ✅ Critical (Must Have)

These items are non-negotiable for Stage {N}:

{Extract "Critical (Must Have)" content from the "What Matters at Each Stage" table}

#### ⏸️ What Doesn't Matter Yet

At Stage {N}, intentionally skip or deprioritize:

{Extract "Doesn't Matter Yet" content from the "What Matters at Each Stage" table}

---

### Essential Development Criteria

Apply these criteria with stage-appropriate rigor:

#### 1. Version Control
{Extract relevant guidance from production-criteria.md}
- Git repository initialized
- .gitignore configured
- Meaningful commit history
- No secrets in repository

**Stage {N} Focus:** {Guidance on what's critical vs optional at this stage}

#### 2. Testing & Quality
{Extract relevant guidance}
- Testing framework configured
- Unit tests for core functionality
- Integration tests for critical paths
- Test coverage reporting

**Stage {N} Focus:** {e.g., "At Stage 1-2, tests are optional. At Stage 3, basic tests required. At Stage 4+, comprehensive coverage."}

#### 3. Error Handling & Logging
{Extract relevant guidance}
- Proper error handling throughout codebase
- User-friendly error messages
- Logging configured
- Error reporting/monitoring

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 4. Documentation
{Extract relevant guidance}
- README with project overview
- Setup/installation instructions
- Usage examples
- API documentation (if applicable)
- Contributing guidelines

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 5. Configuration Management
{Extract relevant guidance}
- Environment variables for configuration
- .env.example template
- No hardcoded credentials
- Separate dev/staging/prod configurations

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 6. Code Quality
{Extract relevant guidance}
- Consistent code style
- Linter configured
- Formatter configured
- No dead code
- Reasonable function/file sizes

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 7. Security
{Extract relevant guidance}
- Dependencies scanned for vulnerabilities
- Input validation
- Authentication/authorization if needed
- HTTPS in production
- Security headers configured

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 8. Dependencies
{Extract relevant guidance}
- Dependencies locked
- Only necessary dependencies
- Regular update plan

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 9. Build & Deployment
{Extract relevant guidance}
- Build process documented
- CI/CD pipeline
- Deployment instructions
- Health check endpoint
- Graceful shutdown handling

**Stage {N} Focus:** {Stage-appropriate expectations}

#### 10. Monitoring & Observability
{Extract relevant guidance}
- Application logging
- Performance monitoring
- Alerting configured
- Metrics collection

**Stage {N} Focus:** {Stage-appropriate expectations}

---

### AI Agent Development Guidelines

**Priority at Stage {N}:** {Extract priority from "AI Agent Readiness" section - e.g., "P2 (Nice to have)" or "P1 (Should have)"}

{If priority is relevant for this stage, include full guidance. Otherwise, note it's not a priority yet.}

AI coding agents (like Claude Code) work best when codebases are clear and well-structured. {If P1/P0 priority:} Here's what matters for Stage {N}:

**Documentation:**
- Clear README with project overview and architecture
- ARCHITECTURE.md explaining system design
- CONTRIBUTING.md with development workflow
- Clear module/component descriptions

**Code Clarity:**
- Descriptive function and variable names
- Consistent coding patterns
- Comments on complex logic and non-obvious decisions
- Type hints/annotations where supported
- Readable over clever code

**Structure:**
- Logical file and directory organization
- Clear separation of concerns
- Consistent naming conventions
- Well-organized imports/dependencies

**Testing:**
- Good test coverage (helps agents understand expected behavior)
- Test names that describe what they're testing
- Example usage in tests

**Context:**
- Clear error messages that explain what went wrong
- Comments explaining "why" not just "what"
- .clinerules or similar for AI-specific instructions (optional)

{If not a priority yet:} At Stage {N}, focus on shipping quickly. AI agent readiness becomes important at Stage 4+.

---

### Technical Design Quality Expectations

{Extract the appropriate stage section from "13. Technical Design Quality"}

At Stage {N}, technical designs should be:

{For Stages 1-2:}
**Minimal Design Approach:**
- 1-2 pages maximum
- Focus on happy path only
- Leverage existing tech in codebase
- Manual testing is fine
- Simple deployment (one command)
- **Always include "What NOT to Build" section**

**Explicitly avoid at Stage {N}:**
- Multi-page comprehensive designs
- Architecture diagrams and complex patterns
- New infrastructure or dependencies
- Automated testing requirements
- Monitoring/observability sections
- Performance optimization plans

{For Stage 3:}
**Moderate Design Detail:**
- 2-3 pages
- Cover main user flows and edge cases
- Testing strategy (30% coverage goal, core flows only)
- Basic deployment plan (staging → production)
- Error handling approach
- **Always include "What NOT to Build" section**

**Should include:**
- Overview and technical approach
- What to build (specific features)
- Implementation steps
- Testing strategy (core flows)
- Deployment approach

**Explicitly avoid at Stage {N}:**
- Comprehensive monitoring/observability
- Advanced architecture patterns
- Performance optimization (unless core to feature)
- Sophisticated rollout strategies
- Extensive security hardening

{For Stages 4-5:}
**Comprehensive Design:**
- 3-5 pages
- All sections present and detailed
- Testing strategy (60-80% coverage goal)
- Monitoring and observability plan
- Security considerations
- Performance requirements
- Rollout strategy
- **Always include "What NOT to Build" section**

**Required sections:**
- Overview and context
- Technical approach
- What to build (detailed)
- Testing strategy (comprehensive)
- Deployment plan
- Monitoring & observability
- Security considerations
- Performance approach
- Rollout strategy
- What NOT to build

**Should address:**
- Scale expectations and growth projections
- Error handling and recovery
- Database schema and indexes
- API design and versioning (if applicable)
- Caching strategy (if needed)
- Background job processing (if needed)

{For Stage 6:}
**Very Comprehensive Design:**
- 5+ pages for complex features
- All Stage 4-5 sections, plus:
- Cost analysis and optimization
- Compliance considerations (SOC2, GDPR, etc.)
- Multi-region deployment strategy (if applicable)
- Advanced monitoring (SLOs, SLIs, error budgets)
- Comprehensive security review
- Performance benchmarks and targets
- A/B testing and experimentation plan
- **Always include "What NOT to Build" section** (prevents gold-plating)

---

### Priority Framework

**P0 (Must Have):** {Extract P0 definition from production-criteria.md}
Version control, basic tests (Stage 3+), error handling, README, environment config

**P1 (Should Have):** {Extract P1 definition}
Comprehensive tests, logging, code quality tools, security basics, build docs

**P2 (Nice to Have):** {Extract P2 definition}
CI/CD, monitoring, advanced security, performance optimization

**At Stage {N}, prioritize:**
{Provide stage-specific guidance on what P0/P1/P2 means}

---

### Common Pitfalls to Avoid at Stage {N}

{Extract anti-patterns from "Common Design Anti-Patterns by Stage" section}

**What to avoid:**
{List the anti-patterns specific to this stage}

**Remember:** Match complexity to company stage. {Stage-specific reminder about over/under-engineering}

---

*For complete details and cross-stage comparisons, see [production-criteria.md](./claude/production-criteria.md) or [.claude/production-criteria.md](./.claude/production-criteria.md)*

<!-- END: Stage-Specific Criteria -->
```

### 4. Update AGENTS.md Idempotently

Read the current AGENTS.md file and update it:

**Step 4.1: Check for existing section**
- Search for the marker: `<!-- BEGIN: Stage-Specific Criteria`
- If found: Section exists and needs updating
- If not found: Section doesn't exist, will be appended

**Step 4.2: Update logic**

**If section exists (updating):**
1. Find the start marker: `<!-- BEGIN: Stage-Specific Criteria (Auto-generated by /configure-agents) -->`
2. Find the end marker: `<!-- END: Stage-Specific Criteria -->`
3. Extract three parts:
   - Content BEFORE the start marker
   - Content to be replaced (ignore this)
   - Content AFTER the end marker
4. Reassemble: `before_content + new_generated_section + after_content`
5. Write the complete updated content back to AGENTS.md

**If section doesn't exist (appending):**
1. Read entire AGENTS.md content
2. Find the last section (before any final "Remember" note or resources)
3. Append the new section with:
   - Blank line
   - Horizontal rule (`---`)
   - Blank line
   - Generated section content
4. Write the updated content back to AGENTS.md

**Important:** Preserve all existing content. Only replace the content between the HTML comment markers or append if markers don't exist.

### 5. Display Confirmation

Output a success message showing:

```
✅ Stage-specific criteria configured!

**Company Stage:** {stage_number}. {stage_name}
**Configuration:** .claude/config.json
**Updated:** AGENTS.md

**What was added/updated:**
- Development priorities for Stage {N}
- Essential criteria (10 categories)
- AI Agent readiness guidelines
- Technical design quality expectations
- Priority framework (P0/P1/P2)
- Common pitfalls to avoid

**Next steps:**
- Review the "Stage-Specific Development Criteria" section in AGENTS.md
- AI agents working in this repo will now follow Stage {N} guidelines
- Re-run `/configure-agents` if your company stage changes

*AI agents can now make stage-appropriate architectural and implementation decisions.*
```

## Examples

**Example invocation (first time):**
```
User: /configure-agents
```

**System response:**
```
No stage configuration found. Let's set up your company stage.

[Displays 6-stage table]

Please select your company stage:
1. Stage 1: Exploratory
2. Stage 2: Early Validation
3. Stage 3: Proven Concept
4. Stage 4: Early Scaling
5. Stage 5: Hypergrowth
6. Stage 6: Established

User selects: 3

✅ Stage configuration saved to .claude/config.json

Generating stage-specific criteria for Stage 3: Proven Concept...

✅ AGENTS.md updated with comprehensive Stage 3 development criteria.
```

**Example invocation (updating existing):**
```
User: /configure-agents
```

**System response:**
```
Current stage: 3. Proven Concept

Do you want to change your company stage?

User selects: Yes

[Displays stage options, user selects Stage 4]

✅ Stage updated to 4. Early Scaling

Updating AGENTS.md with Stage 4 criteria...

✅ AGENTS.md updated successfully.
```

## Guidelines

1. **Comprehensive content**: Extract all relevant details from production-criteria.md for the configured stage
2. **Stage-appropriate guidance**: Emphasize what matters at this stage, de-emphasize what doesn't
3. **Preserve existing content**: Never delete or corrupt other sections of AGENTS.md
4. **Idempotent updates**: Command should work correctly whether section exists or not
5. **Clear markers**: Use HTML comment delimiters exactly as shown (invisible in rendered markdown)
6. **Accurate extraction**: Pull exact content from production-criteria.md, don't improvise
7. **Stage alignment**: Ensure all guidance consistently reflects the configured stage number
8. **File path flexibility**: Support both `claude/production-criteria.md` and `.claude/production-criteria.md` locations

## Goal

Equip AI coding agents with comprehensive, stage-specific development criteria so they can make informed decisions about:
- What level of testing is appropriate
- Whether to add monitoring/observability
- How comprehensive documentation should be
- When to optimize vs. when to ship quickly
- What architectural patterns are appropriate
- How to balance quality with speed

By embedding stage-specific criteria directly in AGENTS.md, AI agents get the context they need to work effectively at your company's current stage, avoiding both under-engineering (Stage 6 expectations at Stage 2) and over-engineering (Stage 2 expectations at Stage 6).
